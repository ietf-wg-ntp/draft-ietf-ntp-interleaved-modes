<?xml version="1.0" encoding="US-ASCII"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC5905 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.5905.xml">
<!ENTITY DATAMIN SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml3/reference.I-D.ietf-ntp-data-minimization.xml">
]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<?rfc strict="yes"?>
<?rfc toc="no"?>
<?rfc tocdepth="3"?>
<?rfc symrefs="yes"?>
<?rfc sortrefs="yes"?>
<?rfc compact="yes"?>
<?rfc subcompact="no"?>

<rfc category="std" docName="draft-mlichvar-ntp-interleaved-modes-00" ipr="trust200902">
  <front>
    <title>NTP interleaved modes</title>

    <author fullname="Miroslav Lichvar" initials="M." surname="Lichvar">
      <organization>Red Hat</organization>
      <address>
        <postal>
          <street>Purkynova 115</street>
          <city>Brno</city>
          <region></region>
          <code>612 00</code>
          <country>Czech Republic</country>
        </postal>
        <email>mlichvar@redhat.com</email>
      </address>
    </author>

    <date year="2017" month="October" day="19"/>

    <area>General</area>

    <workgroup>Internet Engineering Task Force</workgroup>

    <keyword>NTP</keyword>

    <keyword>interleaved mode</keyword>

    <abstract>
        <t>This document extends the specification of Network Time Protocol
            (NTP) version 4 in <xref target="RFC5905">RFC 5905</xref> with special modes
            called the NTP interleaved modes. More specifically, this document describes
            three modes, interleaved client/server, interleaved symmetric and
            interleaved broadcast. These modes enable NTP servers to provide
            their clients and peers with more accurate transmit timestamps that are
            available only after transmitting NTP packets.</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <t>The transmit timestamp is one of the four timestamps included in every
        <xref target="RFC5905">NTPv4</xref> packet used for time
        synchronization. It points to the time when the transmission of the
        packet started. For best accuracy, the timestamp should be made at the
        physical layer of the OSI model, but that is difficult to implement. A
        typical transmit timestamp is made in a software NTP implementation
        using the system clock, before the packet is passed to the operating
        system, and does not include any processing and queuing delays in the
        system, network drivers, and hardware. These delays may add a
        significant error to the offset and network delay measured by clients
        and peers of the server.</t>

      <t>A more accurate transmit timestamp may be available after the
        transmission, e.g. captured in the network driver or at the MAC/PHY
        layer. However, the protocol described in RFC 5905 does not allow the
        server to provide its clients and peers with the timestamp.</t>

      <t>Different mechanisms could be used to exchange the timestamp. This
        document describes interleaved modes, in which an NTP packet contains a
        transmit timestamp corresponding to the previous packet that was sent
        to the client or peer. The NTP packet format is not changed. Only the
        meaning of some timestamp fields is different.</t>

      <t>The protocol requires both servers and clients to keep some state
        specific to the interleaved mode. It prevents traffic amplification
        that would be possible if the timestamp was sent in a separate message
        in order to keep the servers stateless.</t>

      <t>A packet that strictly follows RFC 5905, i.e. it contains a transmit
        timestamp corresponding to the packet itself, is said to be in basic
        mode.</t>

      <section title="Requirements Language">
        <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
          "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
          document are to be interpreted as described in <xref
            target="RFC2119">RFC 2119</xref>.</t>
      </section>
    </section>

    <section title="Client/server mode">
      <t>The interleaved client/server mode is similar to the basic
        client/server mode. The only difference between the two modes is in the
        meaning of the transmit and origin timestamp fields.</t>

      <t>A client request in the basic mode has an origin timestamp equal to
        the transmit timestamp from the previous server response, or is zero. A
        server response in the basic mode has an origin timestamp equal to the
        transmit timestamp from the client's request. The transmit timestamps
        correspond to the packets in which they are included.</t>

      <t>A client request in the interleaved mode has an origin timestamp equal
        to the receive timestamp from the previous server response. A server
        response in the interleaved mode has an origin timestamp equal to the
        receive timestamp from the client's request. The transmit timestamps
        correspond to the previous packets that were sent to the server or
        client.</t>

      <t>A server which supports the interleaved mode needs to save pairs of
        local receive and transmit timestamps. The server SHOULD discard old
        timestamps to limit the amount of memory needed to support clients
        using the interleaved mode. The server MAY separate the timestamps by
        IP addresses, but it SHOULD NOT separate them by port numbers, i.e.
        clients are allowed to change their source port between requests.</t>

      <t>When the server receives a request, it SHOULD compare the origin
        timestamp with all receive timestamps it has saved (for the IP
        address). If a match is found, the server SHOULD respond with a packet
        in the interleaved mode, which contains the transmit timestamp
        corresponding to the packet which had the matching receive timestamp.
        If no match is found, the server MUST NOT respond in the interleaved
        mode. The server MAY always respond in the basic mode. In both cases,
        the server SHOULD save the new receive and transmit timestamps.</t>

      <t>Both servers and clients that support the interleaved mode MUST NOT
        send a packet that has a transmit timestamp equal to the receive
        timestamp in order to reliably detect whether received packets conform
        to the interleaved mode.</t>

      <t>The first request from a client is always in the basic mode. It has a
        zero origin timestamp and zero receive timestamp. Only when it receives
        a valid response from the server, it will be able to send a request in
        the interleaved mode. The client SHOULD limit the number of requests in
        the interleaved mode per server response to prevent processing of very
        old timestamps in case a large number of packets is lost.</t>

      <t>When the client receives a response, it performs all tests described
        in RFC 5905, except it needs to compare the origin timestamp with both
        transmit and receive timestamps from the request to detect the mode of
        the response and detect bogus packets. The client SHOULD NOT update its
        NTP state when an invalid response is received to not lose the
        timestamps which will be needed to complete a measurement when the
        following response in the interleaved mode is received.</t>

      <t>If the packet passed the tests and conforms to the interleaved mode,
        the offset and delay SHOULD be computed using one of the following two
        sets of timestamps. The first one is RECOMMENDED for clients that
        filter measurements based on the delay.</t>

      <t><list>
          <t>T1 - transmit timestamp of the previous request</t>

          <t>T2 - receive timestamp from the previous response</t>

          <t>T3 - transmit timestamp from the latest response</t>

          <t>T4 - receive timestamp of the previous response</t>
      </list></t>

      <t>The second set gives a more accurate measurement of the current
        offset, but the delay is much more sensitive to a frequency error
        between the server and client due to a much longer interval between T1
        and T4.</t>

      <t><list>
          <t>T1 - transmit timestamp of the latest request</t>

          <t>T2 - receive timestamp from the latest response</t>

          <t>T3 - transmit timestamp from the latest response</t>

          <t>T4 - receive timestamp of the previous response</t>
      </list></t>

      <t>Clients MAY filter measurements based on the mode. The maximum number
        of dropped measurements in the basic mode SHOULD be limited in case the
        server does not support or is not able to respond in the interleaved
        mode. Clients that filter measurements based on the delay will
        implicitly prefer measurements in the interleaved mode over the basic
        mode, because they have a shorter delay due to a more accurate transmit
        timestamp (T3).</t>
    </section>

    <section title="Symmetric mode">
      <t>The interleaved symmetric mode uses the same principles as the
        interleaved client/server mode. A packet in the interleaved symmetric
        mode has a transmit timestamp which corresponds to the previous packet
        sent to the peer and an origin timestamp equal to the receive timestamp
        from the last packet received from the peer.</t>

      <t>The use of the interleaved mode in symmetric associations has
        additional restrictions to prevent the peer from matching the transmit
        timestamp with an incorrect packet in case the peers' transmissions do
        not alternate (e.g. they use different polling intervals) and a packet
        was lost.</t>

      <t>A peer A SHOULD send a peer B a packet in the interleaved mode only
        when the following conditions are met:</t>

      <t><list style="numbers">
          <t>The peer A has an active association with the peer B which was
            specified with an option enabling the interleaved mode, or the peer
            A received at least one valid packet in the interleaved mode from
            the peer B.</t>

          <t>The peer A did not send a packet to the peer B since it received
            the last valid packet from the peer B and it sent exactly one
            packet to the peer B between the last two valid packets received
            from the peer B.</t>
      </list></t>

      <t>Otherwise, the peer A SHOULD send the peer B a packet in the basic
        mode.</t>

      <t>If the peer A has no association with the peer B and it responds with
        symmetric passive packets, it does not need to count the packets in
        order to follow the rules, because each request has at most one
        response. The peer SHOULD process the requests in the same way as a
        server which supports the interleaved client/server mode. It MUST NOT
        respond in the interleaved mode if the request was not in the
        interleaved mode.</t>

      <t>The peers SHOULD compute the offset and delay using one the two sets
        of timestamps specified in the client/server section. It MAY switch
        between them to minimize the interval between T1 and T4 in order to
        reduce the error in the measured delay.</t>
    </section>

    <section title="Broadcast mode">
      <t>A packet in the interleaved broadcast mode contains two transmit
        timestamps. One corresponds to the packet itself and is saved in the
        transmit timestamp field. The other corresponds to the previous packet
        and is saved in the origin timestamp field. The packet is compatible
        with the basic mode, which uses a zero origin timestamp.</t>

      <t>A client which does not support the interleaved mode ignores the
        origin timestamp and processes all packets as if they were in the basic
        mode.</t>

      <t>A client which supports the interleaved mode SHOULD check if the
        origin timestamp is not zero to detect packets in the interleaved mode.
        The client SHOULD also compare the origin timestamp with the transmit
        timestamp from the previous packet to detect lost packets. If the
        difference is larger than a specified maximum (e.g. 1 second), the
        packet SHOULD NOT be used for synchronization.</t>

      <t>The client SHOULD compute the offset using the origin timestamp from
        the received packet and the local receive timestamp of the previous
        packet. If the client needs to measure the network delay, it SHOULD use
        the interleaved client/server mode.</t>
    </section>

    <section anchor="Acknowledgements" title="Acknowledgements">
      <t>The interleaved modes described in this document are based on the
        reference NTP implementation written by David Mills.</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This memo includes no request to IANA.</t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>Security issues that apply to the basic modes apply also to the
        interleaved modes. They are described in <xref target="SECNTP">The
          Security of NTP's Datagram Protocol</xref>.</t>

      <t>Clients and peers SHOULD NOT leak the receive timestamp in packets
        sent to other peers or clients (e.g. as a reference timestamp) to
        prevent off-path attackers from easily getting the origin timestamp
        needed to make a valid response in the interleaved mode.</t>

      <t>Clients SHOULD randomize all bits of both receive and transmit
        timestamps, as recommended for the transmit timestamp in the <xref
          target="I-D.ietf-ntp-data-minimization">NTP client data
          minimization</xref>, to make it more difficult for off-path attackers
        to guess the origin timestamp.</t>

      <t>Protecting symmetric associations in the interleaved mode against
        replay attacks is even more difficult than in the basic mode, because
        the NTP state needs to be protected not only between the reception and
        transmission in order to send the peer a packet with a valid origin
        timestamp, but all the time to not lose the timestamps which will be
        needed to complete a measurement when the following packet in the
        interleaved mode is received.</t>
    </section>
  </middle>

  <back>
    <references title="Normative References">
      &RFC2119;

      &RFC5905;
    </references>

    <references title="Informative References">
      &DATAMIN;

      <reference anchor="SECNTP" target="http://eprint.iacr.org/2016/1006">
        <front>
          <title>The Security of NTP's Datagram Protocol</title>

          <author initials="A." surname="Malhotra" fullname="A. Malhotra">
            <organization/>
          </author>
          <author initials="M. V." surname="Gundy" fullname="M. V. Gundy">
            <organization/>
          </author>
          <author initials="M." surname="Varia" fullname="M. Varia">
            <organization/>
          </author>
          <author initials="H." surname="Kennedy" fullname="H. Kennedy">
            <organization/>
          </author>
          <author initials="J." surname="Gardner" fullname="J. Gardner">
            <organization/>
          </author>
          <author initials="S." surname="Goldberg" fullname="S. Goldberg">
            <organization/>
          </author>

          <date year="2016"/>
        </front>
      </reference>
    </references>
  </back>
</rfc>
